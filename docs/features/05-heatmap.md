# Feature 05: Session History Heatmap

## Purpose

**VSCode-exclusive feature** — visualize Claude Code usage patterns over time.
Two views: a GitHub Contributions-style daily heatmap (90 days), and an
hourly usage pattern bar chart (average activity by hour of day).

Both views use **Chart.js** loaded from CDN — no npm dependency needed in the
extension itself, keeping the package size small.

---

## Data Aggregation (`src/webview/heatmap.ts`)

```typescript
async function getHeatmapData(days: number = 90): Promise<HeatmapData> {
  const claudeProjectsDir = path.join(os.homedir(), '.claude', 'projects')
  const allEntries: JournalEntry[] = []

  // Read ALL project directories (global view, not per-project)
  const projectDirs = await fs.readdir(claudeProjectsDir)
  for (const dir of projectDirs) {
    const projectPath = path.join(claudeProjectsDir, dir)
    const stat = await fs.stat(projectPath)
    if (!stat.isDirectory()) continue

    const files = await fs.readdir(projectPath)
    for (const file of files) {
      if (!file.endsWith('.jsonl')) continue
      const entries = await readJsonlFile(path.join(projectPath, file))
      allEntries.push(...entries)
    }
  }

  return {
    daily: aggregateByDay(allEntries, days),
    hourly: aggregateByHour(allEntries, 30),  // last 30 days for hourly
  }
}

function aggregateByDay(entries: JournalEntry[], days: number): DailyUsage[] {
  const cutoff = Date.now() - days * 24 * 3600 * 1000
  const byDate = new Map<string, DailyUsage>()

  for (const entry of entries) {
    const ts = new Date(entry.timestamp)
    if (ts.getTime() < cutoff) continue

    const dateKey = ts.toISOString().slice(0, 10)  // "2026-02-24"
    const existing = byDate.get(dateKey) ?? {
      date: dateKey, cost: 0, sessionCount: 0, tokensTotal: 0
    }
    existing.cost += entry.costUSD ?? 0
    existing.tokensTotal += (entry.usage?.input_tokens ?? 0) + (entry.usage?.output_tokens ?? 0)
    byDate.set(dateKey, existing)
  }

  // Count sessions: assume new session if gap > 30 min from previous entry on same day
  // (simplified: count JSONL files per day instead)

  // Fill in missing days with zeroes
  const result: DailyUsage[] = []
  for (let i = days - 1; i >= 0; i--) {
    const d = new Date(Date.now() - i * 24 * 3600 * 1000)
    const key = d.toISOString().slice(0, 10)
    result.push(byDate.get(key) ?? { date: key, cost: 0, sessionCount: 0, tokensTotal: 0 })
  }
  return result
}

function aggregateByHour(entries: JournalEntry[], days: number): HourlyUsage[] {
  const cutoff = Date.now() - days * 24 * 3600 * 1000
  const byHour = new Array(24).fill(null).map((_, h) => ({
    hour: h, totalCost: 0, count: 0
  }))

  for (const entry of entries) {
    const ts = new Date(entry.timestamp)
    if (ts.getTime() < cutoff) continue
    const h = ts.getHours()
    byHour[h].totalCost += entry.costUSD ?? 0
    byHour[h].count++
  }

  return byHour.map(h => ({
    hour: h.hour,
    avgCost: h.count > 0 ? h.totalCost / h.count : 0,
    count: h.count,
  }))
}
```

---

## Heatmap Rendering (GitHub Contributions Style)

Implemented as pure HTML/CSS in the WebView — **no Chart.js** for the heatmap,
just a CSS grid. Chart.js is used only for the bar chart.

### HTML Structure

```html
<div class="heatmap-container">
  <div class="heatmap-header">
    <!-- Month labels, generated by JS -->
  </div>
  <div class="heatmap-grid">
    <!-- 90 cells, one per day -->
    <!-- data-date, data-cost set by JS -->
  </div>
  <div class="heatmap-legend">
    Less <span class="cell l0"></span>
         <span class="cell l1"></span>
         <span class="cell l2"></span>
         <span class="cell l3"></span>
         <span class="cell l4"></span> More
  </div>
</div>
```

### CSS Grid

```css
.heatmap-grid {
  display: grid;
  grid-template-columns: repeat(13, 1fr);  /* ~13 weeks */
  grid-auto-flow: column;
  gap: 3px;
}

.heatmap-cell {
  width: 12px;
  height: 12px;
  border-radius: 2px;
  cursor: pointer;
}

/* Intensity levels — use green palette similar to GitHub */
.cell.l0 { background-color: var(--vscode-editor-background); border: 1px solid var(--vscode-panel-border); }
.cell.l1 { background-color: #0e4429; }
.cell.l2 { background-color: #006d32; }
.cell.l3 { background-color: #26a641; }
.cell.l4 { background-color: #39d353; }
```

### Level Thresholds

Assign level based on cost relative to max daily cost in the dataset:

```javascript
function getCostLevel(cost, maxCost) {
  if (cost === 0) return 0
  const ratio = cost / maxCost
  if (ratio < 0.25) return 1
  if (ratio < 0.50) return 2
  if (ratio < 0.75) return 3
  return 4
}
```

### Tooltip on Hover

```javascript
cell.addEventListener('mouseenter', (e) => {
  tooltip.textContent = `${cell.dataset.date}: $${parseFloat(cell.dataset.cost).toFixed(3)}`
  tooltip.style.display = 'block'
  // position near cursor
})
```

---

## Hourly Bar Chart (Chart.js)

```html
<canvas id="hourlyChart" height="120"></canvas>

<script nonce="${nonce}" src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script nonce="${nonce}">
  const ctx = document.getElementById('hourlyChart').getContext('2d')
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Array.from({length: 24}, (_, i) => `${i}h`),
      datasets: [{
        label: 'Avg cost per session ($)',
        data: hourlyData.map(h => h.avgCost),
        backgroundColor: getComputedStyle(document.body)
          .getPropertyValue('--vscode-progressBar-background').trim(),
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `$${ctx.parsed.y.toFixed(4)} avg (${hourlyData[ctx.dataIndex].count} sessions)`
          }
        }
      },
      scales: {
        x: {
          ticks: { color: getComputedStyle(document.body).getPropertyValue('--vscode-foreground') }
        },
        y: {
          ticks: { color: getComputedStyle(document.body).getPropertyValue('--vscode-foreground') },
          beginAtZero: true,
        }
      }
    }
  })
</script>
```

### Chart.js Version

Pin to `chart.js@4.4.0` in the CDN URL. Do not use `@latest`.

---

## Data Refresh

Heatmap and hourly data are read from JSONL only (no API call).
Recalculate on:
- Extension activation (once, then cached in memory)
- JSONL FileWatcher trigger
- User clicks "↻ Refresh" in the dashboard

Because this reads all 90 days of JSONL, it can be slow on large datasets.
Run it on a background Node.js worker or use `setTimeout(..., 0)` to avoid
blocking the extension host.

---

## Performance Considerations

If `~/.claude/projects/` contains many large JSONL files, reading all 90 days
can take >1 second. Mitigations:

1. Read JSONL files in parallel with `Promise.all`
2. Skip files with `mtime < 90 days ago` using `fs.stat` before reading
3. Cache the aggregated result to disk (`~/.claude/vscode-claude-status-heatmap-cache.json`)
   with a 5-minute TTL
4. Show stale heatmap while fresh data loads in the background
